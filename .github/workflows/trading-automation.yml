name: Trading Automation

on:
  # Schedule: Run during market hours (Mon-Fri, 9:15 AM - 3:30 PM IST)
  schedule:
    # 3:45 AM UTC = 9:15 AM IST (Market Open)
    - cron: "45 3 * * 1-5"
    # 10:00 AM UTC = 3:30 PM IST (Market Close)
    - cron: "0 10 * * 1-5"

  # Manual trigger
  workflow_dispatch:
    inputs:
      action:
        description: "Action to perform"
        required: true
        default: "paper_trade"
        type: choice
        options:
          - paper_trade
          - live_trade
          - train_ai
          - both

  # Webhook/API trigger
  repository_dispatch:
    types: [trade-trigger, train-trigger]

jobs:
  train-ai:
    runs-on: ubuntu-latest
    if: github.event.inputs.action == 'train_ai' || github.event.inputs.action == 'both' || github.event_name == 'repository_dispatch' && github.event.action == 'train-trigger'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Configure environment
        env:
          KITE_API_KEY: ${{ secrets.KITE_API_KEY }}
          KITE_API_SECRET: ${{ secrets.KITE_API_SECRET }}
          KITE_ACCESS_TOKEN: ${{ secrets.KITE_ACCESS_TOKEN }}
          ZERODHA_USER_ID: ${{ secrets.ZERODHA_USER_ID }}
          ZERODHA_PASSWORD: ${{ secrets.ZERODHA_PASSWORD }}
          ZERODHA_PIN: ${{ secrets.ZERODHA_PIN }}
        run: |
          echo "KITE_API_KEY=${KITE_API_KEY}" >> .env
          echo "KITE_API_SECRET=${KITE_API_SECRET}" >> .env
          echo "KITE_ACCESS_TOKEN=${KITE_ACCESS_TOKEN}" >> .env
          echo "ZERODHA_USER_ID=${ZERODHA_USER_ID}" >> .env
          echo "ZERODHA_PASSWORD=${ZERODHA_PASSWORD}" >> .env
          echo "ZERODHA_PIN=${ZERODHA_PIN}" >> .env

      - name: Train AI models
        run: python3 scripts/train_ai.py

      - name: Upload AI models artifact
        uses: actions/upload-artifact@v4
        with:
          name: ai-models-${{ github.run_number }}
          path: ai_data/
          retention-days: 30

      - name: Notify on completion
        if: always()
        run: |
          echo "AI training completed with status: ${{ job.status }}"
          # Add Slack/Discord webhook notification here if needed

  paper-trade:
    runs-on: ubuntu-latest
    if: github.event.inputs.action == 'paper_trade' || github.event_name == 'repository_dispatch' && github.event.action == 'paper-trade-trigger'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Configure environment
        env:
          KITE_API_KEY: ${{ secrets.KITE_API_KEY }}
          KITE_API_SECRET: ${{ secrets.KITE_API_SECRET }}
          KITE_ACCESS_TOKEN: ${{ secrets.KITE_ACCESS_TOKEN }}
          ZERODHA_USER_ID: ${{ secrets.ZERODHA_USER_ID }}
          ZERODHA_PASSWORD: ${{ secrets.ZERODHA_PASSWORD }}
          ZERODHA_PIN: ${{ secrets.ZERODHA_PIN }}
        run: |
          echo "KITE_API_KEY=${KITE_API_KEY}" >> .env
          echo "KITE_API_SECRET=${KITE_API_SECRET}" >> .env
          echo "KITE_ACCESS_TOKEN=${KITE_ACCESS_TOKEN}" >> .env
          echo "ZERODHA_USER_ID=${ZERODHA_USER_ID}" >> .env
          echo "ZERODHA_PASSWORD=${ZERODHA_PASSWORD}" >> .env
          echo "ZERODHA_PIN=${ZERODHA_PIN}" >> .env
          echo "TRADING_MODE=paper" >> .env
          echo "‚úÖ Environment configured for paper trading"

      - name: Check market hours (IST)
        id: market_check
        run: |
          # Get current time in IST (UTC+5:30)
          IST_TIME=$(TZ='Asia/Kolkata' date +'%H:%M')
          IST_HOUR=$(TZ='Asia/Kolkata' date +'%H')
          IST_MINUTE=$(TZ='Asia/Kolkata' date +'%M')
          IST_DAY=$(TZ='Asia/Kolkata' date +'%u')

          echo "Current IST time: $IST_TIME"
          echo "Day of week: $IST_DAY (1=Mon, 7=Sun)"

          # Market hours: 9:15 AM - 3:30 PM IST (Mon-Fri)
          # Convert to minutes for easier comparison
          CURRENT_MINUTES=$((10#$IST_HOUR * 60 + 10#$IST_MINUTE))
          MARKET_OPEN=$((9 * 60 + 15))   # 9:15 AM = 555 minutes
          MARKET_CLOSE=$((15 * 60 + 30)) # 3:30 PM = 930 minutes

          echo "Current minutes: $CURRENT_MINUTES"
          echo "Market open: $MARKET_OPEN (9:15 AM)"
          echo "Market close: $MARKET_CLOSE (3:30 PM)"

          # Check if it's a weekday (1-5) and within market hours
          if [ "$IST_DAY" -ge 1 ] && [ "$IST_DAY" -le 5 ]; then
            if [ "$CURRENT_MINUTES" -ge "$MARKET_OPEN" ] && [ "$CURRENT_MINUTES" -le "$MARKET_CLOSE" ]; then
              echo "‚úÖ Market is OPEN - Proceeding with paper trading"
              echo "market_open=true" >> $GITHUB_OUTPUT
            else
              echo "‚è∞ Market is CLOSED - Current time $IST_TIME is outside market hours (9:15 AM - 3:30 PM IST)"
              echo "market_open=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "üìÖ Weekend - Market is CLOSED"
            echo "market_open=false" >> $GITHUB_OUTPUT
          fi

      - name: Prepare runtime directories
        if: steps.market_check.outputs.market_open == 'true'
        run: |
          mkdir -p data/logs ai_data

      - name: Download latest AI models (optional)
        if: steps.market_check.outputs.market_open == 'true'
        uses: dawidd6/action-download-artifact@v3
        continue-on-error: true
        with:
          workflow: trading-automation.yml
          name: ai-models-
          path: ai_data/
          search_artifacts: true

      - name: Run paper trading
        if: steps.market_check.outputs.market_open == 'true'
        run: |
          python3 scripts/paper_trade.py

      - name: Upload trading logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: paper-trading-logs-${{ github.run_number }}
          path: data/logs/
          retention-days: 90

      - name: Notify on completion
        if: always()
        run: |
          echo "Paper trading completed with status: ${{ job.status }}"

  live-trade:
    runs-on: ubuntu-latest
    if: github.event.inputs.action == 'live_trade' || github.event.inputs.action == 'both' || github.event_name == 'schedule' || github.event_name == 'repository_dispatch' && github.event.action == 'trade-trigger'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Configure environment for LIVE trading
        env:
          KITE_API_KEY: ${{ secrets.KITE_API_KEY }}
          KITE_API_SECRET: ${{ secrets.KITE_API_SECRET }}
          KITE_ACCESS_TOKEN: ${{ secrets.KITE_ACCESS_TOKEN }}
          ZERODHA_USER_ID: ${{ secrets.ZERODHA_USER_ID }}
          ZERODHA_PASSWORD: ${{ secrets.ZERODHA_PASSWORD }}
          ZERODHA_PIN: ${{ secrets.ZERODHA_PIN }}
          MAX_LIVE_CAPITAL: ${{ secrets.MAX_LIVE_CAPITAL }}
          MAX_DAILY_LOSS: ${{ secrets.MAX_DAILY_LOSS }}
          ORDER_TIMEOUT: ${{ secrets.ORDER_TIMEOUT }}
          SLIPPAGE_TOLERANCE: ${{ secrets.SLIPPAGE_TOLERANCE }}
          CHECK_INTERVAL: ${{ secrets.CHECK_INTERVAL }}
        run: |
          echo "KITE_API_KEY=${KITE_API_KEY}" >> .env
          echo "KITE_API_SECRET=${KITE_API_SECRET}" >> .env
          echo "KITE_ACCESS_TOKEN=${KITE_ACCESS_TOKEN}" >> .env
          echo "ZERODHA_USER_ID=${ZERODHA_USER_ID}" >> .env
          echo "ZERODHA_PASSWORD=${ZERODHA_PASSWORD}" >> .env
          echo "ZERODHA_PIN=${ZERODHA_PIN}" >> .env
          echo "TRADING_MODE=live" >> .env
          echo "MAX_LIVE_CAPITAL=${MAX_LIVE_CAPITAL:-1000}" >> .env
          echo "MAX_DAILY_LOSS=${MAX_DAILY_LOSS:-100}" >> .env
          echo "ORDER_TIMEOUT=${ORDER_TIMEOUT:-30}" >> .env
          echo "SLIPPAGE_TOLERANCE=${SLIPPAGE_TOLERANCE:-0.003}" >> .env
          echo "CHECK_INTERVAL=${CHECK_INTERVAL:-120}" >> .env
          echo "MAX_POSITION_SIZE_PCT=0.1" >> .env
          echo "ENABLE_PAPER_TRADING=false" >> .env
          echo "‚ö†Ô∏è  Environment configured for LIVE trading"
          echo "   Capital: ‚Çπ${MAX_LIVE_CAPITAL:-1000}"
          echo "   Daily Loss Limit: ‚Çπ${MAX_DAILY_LOSS:-100}"
          echo "   Order Timeout: ${ORDER_TIMEOUT:-30}s"
          echo "   Slippage Tolerance: ${SLIPPAGE_TOLERANCE:-0.003}"

      - name: Check market hours (IST)
        id: market_check
        run: |
          # Get current time in IST (UTC+5:30)
          IST_TIME=$(TZ='Asia/Kolkata' date +'%H:%M')
          IST_HOUR=$(TZ='Asia/Kolkata' date +'%H')
          IST_MINUTE=$(TZ='Asia/Kolkata' date +'%M')
          IST_DAY=$(TZ='Asia/Kolkata' date +'%u')

          echo "Current IST time: $IST_TIME"
          echo "Day of week: $IST_DAY (1=Mon, 7=Sun)"

          # Market hours: 9:15 AM - 3:30 PM IST (Mon-Fri)
          # Convert to minutes for easier comparison
          CURRENT_MINUTES=$((10#$IST_HOUR * 60 + 10#$IST_MINUTE))
          MARKET_OPEN=$((9 * 60 + 15))   # 9:15 AM = 555 minutes
          MARKET_CLOSE=$((15 * 60 + 30)) # 3:30 PM = 930 minutes

          echo "Current minutes: $CURRENT_MINUTES"
          echo "Market open: $MARKET_OPEN (9:15 AM)"
          echo "Market close: $MARKET_CLOSE (3:30 PM)"

          # Check if it's a weekday (1-5) and within market hours
          if [ "$IST_DAY" -ge 1 ] && [ "$IST_DAY" -le 5 ]; then
            if [ "$CURRENT_MINUTES" -ge "$MARKET_OPEN" ] && [ "$CURRENT_MINUTES" -le "$MARKET_CLOSE" ]; then
              echo "‚úÖ Market is OPEN - Proceeding with paper trading"
              echo "market_open=true" >> $GITHUB_OUTPUT
            else
              echo "‚è∞ Market is CLOSED - Current time $IST_TIME is outside market hours (9:15 AM - 3:30 PM IST)"
              echo "market_open=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "üìÖ Weekend - Market is CLOSED"
            echo "market_open=false" >> $GITHUB_OUTPUT
          fi

      - name: Prepare runtime directories
        if: steps.market_check.outputs.market_open == 'true'
        run: |
          mkdir -p data/logs ai_data

      - name: Download latest AI models (optional)
        if: steps.market_check.outputs.market_open == 'true'
        uses: dawidd6/action-download-artifact@v3
        continue-on-error: true
        with:
          workflow: trading-automation.yml
          # Tip: this action searches artifacts when search_artifacts=true; name acts as a filter
          name: ai-models-
          path: ai_data/
          search_artifacts: true

      - name: Run LIVE trading (REAL MONEY)
        if: steps.market_check.outputs.market_open == 'true'
        run: |
          # ‚ö†Ô∏è  LIVE TRADING - REAL MONEY AT RISK
          # Capital limit: ‚Çπ1,000 (configurable via MAX_LIVE_CAPITAL secret)
          # Daily loss limit: ‚Çπ100 (configurable via MAX_DAILY_LOSS secret)
          # Safety features:
          #   - Thread-safe capital tracking
          #   - Automatic halt on daily loss limit
          #   - LIMIT orders only (0.3% slippage tolerance)
          #   - Duplicate order prevention
          #   - Position reconciliation with halt on mismatch
          #   - Broker health monitoring
          #   - Automatic square-off at 3:20 PM IST
          echo "Starting LIVE trading with production safety features..."
          python3 scripts/live_trade.py

      - name: Upload trading logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: live-trading-logs-${{ github.run_number }}
          path: data/logs/
          retention-days: 90

      - name: Upload AI models
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ai-models-live-${{ github.run_number }}
          path: ai_data/
          retention-days: 30

      - name: Notify on completion
        if: always()
        run: |
          echo "‚ö†Ô∏è  LIVE trading completed with status: ${{ job.status }}"
          # Add Slack/Discord webhook notification here if needed
