<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>AI Training Hub - Portfolio Dashboard</title>
        <link rel="stylesheet" href="/static/css/style.css" />
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
            rel="stylesheet"
        />
        <style>
            :root {
                --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                --gradient-success: linear-gradient(135deg, #10b981 0%, #059669 100%);
                --gradient-danger: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
                --gradient-warning: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            }
            
            .tab-container {
                display: flex;
                gap: 1rem;
                margin-bottom: 2rem;
                border-bottom: 2px solid rgba(255,255,255,0.1);
            }
            
            .tab {
                padding: 1rem 2rem;
                cursor: pointer;
                border: none;
                background: transparent;
                color: var(--text-secondary);
                font-weight: 600;
                transition: all 0.3s ease;
                border-bottom: 3px solid transparent;
            }
            
            .tab.active {
                color: #667eea;
                border-bottom-color: #667eea;
            }
            
            .tab-content {
                display: none;
            }
            
            .tab-content.active {
                display: block;
                animation: fadeIn 0.3s ease;
            }
            
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(10px); }
                to { opacity: 1; transform: translateY(0); }
            }
            
            .status-card {
                background: var(--card-background);
                border-radius: 12px;
                padding: 1.5rem;
                margin-bottom: 1.5rem;
            }
            
            .status-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 1rem;
            }
            
            .status-badge {
                display: inline-flex;
                align-items: center;
                gap: 0.5rem;
                padding: 0.5rem 1rem;
                border-radius: 20px;
                font-size: 0.875rem;
                font-weight: 600;
            }
            
            .badge-idle {
                background: rgba(156, 163, 175, 0.2);
                color: #9ca3af;
            }
            
            .badge-running {
                background: rgba(59, 130, 246, 0.2);
                color: #3b82f6;
                animation: pulse 2s infinite;
            }
            
            .badge-stopped {
                background: rgba(239, 68, 68, 0.2);
                color: #ef4444;
            }
            
            .badge-success {
                background: rgba(16, 185, 129, 0.2);
                color: #10b981;
            }
            
            @keyframes pulse {
                0%, 100% { opacity: 1; }
                50% { opacity: 0.6; }
            }
            
            .metrics-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 1rem;
                margin: 1.5rem 0;
            }
            
            .metric-card {
                background: rgba(102, 126, 234, 0.05);
                border: 1px solid rgba(102, 126, 234, 0.2);
                border-radius: 12px;
                padding: 1.5rem;
                text-align: center;
            }
            
            .metric-value {
                font-size: 2.5rem;
                font-weight: 800;
                background: var(--gradient-primary);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                margin: 0.5rem 0;
            }
            
            .metric-label {
                font-size: 0.875rem;
                color: var(--text-secondary);
                text-transform: uppercase;
                letter-spacing: 1px;
            }
            
            .control-panel {
                display: flex;
                gap: 1rem;
                margin: 1.5rem 0;
                flex-wrap: wrap;
            }
            
            .btn {
                padding: 0.75rem 1.5rem;
                border-radius: 8px;
                border: none;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s ease;
                display: inline-flex;
                align-items: center;
                gap: 0.5rem;
            }
            
            .btn-primary {
                background: var(--gradient-primary);
                color: white;
            }
            
            .btn-success {
                background: var(--gradient-success);
                color: white;
            }
            
            .btn-danger {
                background: var(--gradient-danger);
                color: white;
            }
            
            .btn-secondary {
                background: rgba(156, 163, 175, 0.2);
                color: var(--text-primary);
            }
            
            .btn:hover:not(:disabled) {
                transform: translateY(-2px);
                box-shadow: 0 8px 16px rgba(0,0,0,0.3);
            }
            
            .btn:disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }
            
            .log-viewer {
                background: #0d1117;
                border-radius: 8px;
                padding: 1rem;
                max-height: 400px;
                overflow-y: auto;
                font-family: 'Monaco', 'Courier New', monospace;
                font-size: 0.85rem;
                margin-top: 1rem;
            }
            
            .log-entry {
                padding: 0.5rem;
                border-left: 3px solid transparent;
                margin-bottom: 0.25rem;
            }
            
            .log-info {
                border-left-color: #3b82f6;
                color: #c9d1d9;
            }
            
            .log-error {
                border-left-color: #ef4444;
                color: #fca5a5;
            }
            
            .log-success {
                border-left-color: #10b981;
                color: #6ee7b7;
            }
            
            .log-timestamp {
                color: #6b7280;
                margin-right: 1rem;
            }
            
            .progress-container {
                margin: 1.5rem 0;
            }
            
            .progress-bar {
                width: 100%;
                height: 10px;
                background: rgba(255,255,255,0.05);
                border-radius: 10px;
                overflow: hidden;
            }
            
            .progress-fill {
                height: 100%;
                background: var(--gradient-primary);
                transition: width 0.5s ease;
            }
            
            .progress-text {
                margin-top: 0.5rem;
                font-size: 0.875rem;
                color: var(--text-secondary);
            }
            
            .data-table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 1rem;
            }
            
            .data-table th {
                background: rgba(102, 126, 234, 0.1);
                padding: 0.75rem;
                text-align: left;
                font-weight: 600;
                border-bottom: 2px solid rgba(102, 126, 234, 0.3);
            }
            
            .data-table td {
                padding: 0.75rem;
                border-bottom: 1px solid rgba(255,255,255,0.05);
            }
            
            .data-table tr:hover {
                background: rgba(102, 126, 234, 0.05);
            }
            
            .pnl-positive {
                color: #10b981;
                font-weight: 600;
            }
            
            .pnl-negative {
                color: #ef4444;
                font-weight: 600;
            }
            
            .connection-status {
                display: flex;
                align-items: center;
                gap: 0.5rem;
                padding: 0.5rem 1rem;
                background: rgba(16, 185, 129, 0.1);
                border: 1px solid rgba(16, 185, 129, 0.3);
                border-radius: 8px;
                font-size: 0.875rem;
            }
            
            .status-indicator {
                width: 10px;
                height: 10px;
                border-radius: 50%;
                background: #10b981;
                animation: pulse 2s infinite;
            }
            
            .form-group {
                margin: 1rem 0;
            }
            
            .form-label {
                display: block;
                margin-bottom: 0.5rem;
                font-weight: 600;
            }
            
            .form-input {
                width: 100%;
                padding: 0.75rem;
                background: var(--background-secondary);
                border: 1px solid rgba(255,255,255,0.1);
                border-radius: 8px;
                color: var(--text-primary);
                font-family: inherit;
            }
            
            .symbol-selector {
                display: flex;
                flex-wrap: wrap;
                gap: 0.5rem;
                margin-top: 0.5rem;
            }
            
            .symbol-chip {
                padding: 0.5rem 1rem;
                background: rgba(102, 126, 234, 0.1);
                border: 2px solid rgba(102, 126, 234, 0.3);
                border-radius: 20px;
                cursor: pointer;
                transition: all 0.3s ease;
            }
            
            .symbol-chip.selected {
                background: rgba(102, 126, 234, 0.3);
                border-color: #667eea;
            }
            
            .section-title {
                font-size: 1.5rem;
                font-weight: 700;
                margin: 2rem 0 1rem 0;
                color: var(--text-primary);
            }
        </style>
    </head>
    <body>
        <div class="container">
            <!-- Sidebar -->
            <aside class="sidebar">
                <div class="sidebar-header">
                    <h2 class="sidebar-title">üìä Portfolio</h2>
                </div>
                <nav class="sidebar-nav">
                    <a href="/" class="nav-item">
                        <span class="nav-icon">üè†</span>
                        <span>Dashboard</span>
                    </a>
                    <a href="/holdings" class="nav-item">
                        <span class="nav-icon">üíº</span>
                        <span>Holdings</span>
                    </a>
                    <a href="/positions" class="nav-item">
                        <span class="nav-icon">üìà</span>
                        <span>Positions</span>
                    </a>
                    <a href="/funds" class="nav-item">
                        <span class="nav-icon">üí∞</span>
                        <span>Funds</span>
                    </a>
                    <a href="/ai-training" class="nav-item active">
                        <span class="nav-icon">ü§ñ</span>
                        <span>AI Training</span>
                    </a>
                </nav>
            </aside>

            <!-- Main Content -->
            <main class="main-content">
                <div class="page-header">
                    <h1 class="page-title">ü§ñ AI Training Hub</h1>
                    <div id="connectionStatus" class="connection-status">
                        <div class="status-indicator"></div>
                        <span>Connected to Zerodha</span>
                    </div>
                </div>

                <!-- Tab Navigation -->
                <div class="tab-container">
                    <button class="tab active" onclick="switchTab('overview')">üìä Overview</button>
                    <button class="tab" onclick="switchTab('training')">üß† Model Training</button>
                    <button class="tab" onclick="switchTab('paper-trading')">üìù Paper Trading</button>
                    <button class="tab" onclick="switchTab('logs')">üìã Logs</button>
                </div>

                <!-- Overview Tab -->
                <div id="overview-tab" class="tab-content active">
                    <div class="status-card">
                        <div class="status-header">
                            <h2>System Status</h2>
                            <button class="btn btn-secondary" onclick="refreshAll()">üîÑ Refresh All</button>
                        </div>
                        
                        <div class="metrics-grid">
                            <div class="metric-card">
                                <div class="metric-label">Paper Trading</div>
                                <div id="paperTradingState" class="metric-value">IDLE</div>
                                <span id="paperTradingBadge" class="status-badge badge-idle">Idle</span>
                            </div>
                            <div class="metric-card">
                                <div class="metric-label">Total Trades</div>
                                <div id="totalTrades" class="metric-value">0</div>
                                <span class="metric-label">Executed</span>
                            </div>
                            <div class="metric-card">
                                <div class="metric-label">Virtual Capital</div>
                                <div id="virtualCapital" class="metric-value">‚Çπ0</div>
                                <span id="capitalChange" class="metric-label">+0.00%</span>
                            </div>
                            <div class="metric-card">
                                <div class="metric-label">Win Rate</div>
                                <div id="winRate" class="metric-value">0%</div>
                                <span class="metric-label">Success Rate</span>
                            </div>
                        </div>
                    </div>

                    <div class="status-card">
                        <h2 class="section-title">AI Model Performance</h2>
                        <div class="metrics-grid">
                            <div class="metric-card">
                                <div class="metric-label">Patterns Detected</div>
                                <div id="patternsDetected" class="metric-value">0</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-label">Predictions Made</div>
                                <div id="predictionsMade" class="metric-value">0</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-label">Success Rate</div>
                                <div id="predictionAccuracy" class="metric-value">0%</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-label">Total Candles</div>
                                <div id="totalCandles" class="metric-value">0</div>
                            </div>
                        </div>
                    </div>

                    <div class="status-card">
                        <h2 class="section-title">Active Positions</h2>
                        <table id="activePositionsTable" class="data-table">
                            <thead>
                                <tr>
                                    <th>Symbol</th>
                                    <th>Quantity</th>
                                    <th>Avg Price</th>
                                    <th>Investment</th>
                                    <th>Current P&L</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="5" style="text-align: center; color: var(--text-secondary);">
                                        No active positions
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Model Training Tab -->
                <div id="training-tab" class="tab-content">
                    <div class="status-card">
                        <div class="status-header">
                            <h2>Train AI Models</h2>
                            <span id="trainingStatus" class="status-badge badge-idle">Ready</span>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Select Stocks</label>
                            <div class="symbol-selector" id="symbolSelector">
                                <!-- Will be populated by JS -->
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Lookback Period (Days)</label>
                            <input type="number" class="form-input" id="lookbackDays" value="60" min="30" max="365" />
                        </div>

                        <div id="trainingProgress" class="progress-container" style="display: none;">
                            <div class="progress-bar">
                                <div id="trainingProgressFill" class="progress-fill" style="width: 0%"></div>
                            </div>
                            <div id="trainingProgressText" class="progress-text">Initializing...</div>
                        </div>

                        <div class="control-panel">
                            <button class="btn btn-primary" id="startTrainingBtn" onclick="startTraining()">
                                üöÄ Start Training
                            </button>
                            <button class="btn btn-secondary" onclick="loadTrainingHistory()">
                                üìú View History
                            </button>
                        </div>
                    </div>

                    <div id="trainingHistoryCard" class="status-card" style="display: none;">
                        <h2 class="section-title">Training History</h2>
                        <div id="trainingHistoryList"></div>
                    </div>
                </div>

                <!-- Paper Trading Tab -->
                <div id="paper-trading-tab" class="tab-content">
                    <div class="status-card">
                        <div class="status-header">
                            <h2>Paper Trading Control</h2>
                            <span id="ptStatus" class="status-badge badge-idle">Idle</span>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Initial Capital (‚Çπ)</label>
                            <input type="number" class="form-input" id="initialCapital" value="100000" step="10000" />
                        </div>

                        <div class="form-group">
                            <label class="form-label">Select Stocks for Trading</label>
                            <div class="symbol-selector" id="ptSymbolSelector">
                                <!-- Will be populated by JS -->
                            </div>
                        </div>

                        <div class="control-panel">
                            <button class="btn btn-success" id="startPTBtn" onclick="startPaperTrading()">
                                ‚ñ∂Ô∏è Start Paper Trading
                            </button>
                            <button class="btn btn-danger" id="stopPTBtn" onclick="stopPaperTrading()" style="display: none;">
                                ‚èπÔ∏è Stop Paper Trading
                            </button>
                            <button class="btn btn-secondary" onclick="refreshPaperTradingStatus()">
                                üîÑ Refresh Status
                            </button>
                        </div>

                        <div class="metrics-grid" style="margin-top: 2rem;">
                            <div class="metric-card">
                                <div class="metric-label">Iterations</div>
                                <div id="ptIterations" class="metric-value">0</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-label">Last Update</div>
                                <div id="ptLastUpdate" class="metric-value" style="font-size: 1rem;">-</div>
                            </div>
                        </div>
                    </div>

                    <div class="status-card">
                        <h2 class="section-title">Recent Trades</h2>
                        <table id="recentTradesTable" class="data-table">
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Symbol</th>
                                    <th>Type</th>
                                    <th>Quantity</th>
                                    <th>Price</th>
                                    <th>P&L</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="6" style="text-align: center; color: var(--text-secondary);">
                                        No trades yet
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Logs Tab -->
                <div id="logs-tab" class="tab-content">
                    <div class="status-card">
                        <div class="status-header">
                            <h2>Paper Trading Logs</h2>
                            <button class="btn btn-secondary" onclick="refreshLogs()">üîÑ Refresh</button>
                        </div>
                        <div id="logViewer" class="log-viewer">
                            <div class="log-entry log-info">
                                <span class="log-timestamp">--:--:--</span>
                                <span>Waiting for paper trading to start...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <script>
            // Tab switching
            function switchTab(tabName) {
                // Hide all tabs
                document.querySelectorAll('.tab-content').forEach(tab => {
                    tab.classList.remove('active');
                });
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                
                // Show selected tab
                document.getElementById(`${tabName}-tab`).classList.add('active');
                event.target.classList.add('active');
                
                // Refresh data when switching tabs
                if (tabName === 'overview') refreshOverview();
                if (tabName === 'paper-trading') refreshPaperTradingStatus();
                if (tabName === 'logs') refreshLogs();
            }

            // Populate symbol selectors
            const defaultSymbols = [
                'RELIANCE', 'TCS', 'INFY', 'HDFCBANK', 'ICICIBANK',
                'SBIN', 'BHARTIARTL', 'ITC', 'WIPRO', 'LT',
                'AXISBANK', 'KOTAKBANK', 'HINDUNILVR', 'MARUTI', 'BAJFINANCE',
                'ASIANPAINT', 'TITAN', 'NESTLEIND', 'ULTRACEMCO', 'SUNPHARMA',
                'TATASTEEL', 'POWERGRID', 'NTPC', 'ONGC', 'COALINDIA',
                'TECHM', 'HCLTECH', 'DIVISLAB', 'DRREDDY', 'CIPLA',
                'BAJAJFINSV', 'M&M', 'TATAMOTORS', 'ADANIPORTS', 'JSWSTEEL',
                'HINDALCO', 'GRASIM', 'BRITANNIA', 'SHREECEM', 'EICHERMOT',
                'HEROMOTOCO', 'BPCL', 'IOC'
            ];

            async function populateSymbolSelectors() {
                const selector1 = document.getElementById('symbolSelector');
                const selector2 = document.getElementById('ptSymbolSelector');
                
                let allSymbols = [...defaultSymbols];
                let holdingsSymbols = [];
                
                // Fetch current holdings from API
                try {
                    const response = await fetch('/api/portfolio');
                    const result = await response.json();
                    
                    if (result.success && result.data && result.data.holdings) {
                        holdingsSymbols = result.data.holdings.map(h => h.symbol);
                        // Add holdings symbols to the beginning if not already present
                        holdingsSymbols.forEach(symbol => {
                            if (!allSymbols.includes(symbol)) {
                                allSymbols.unshift(symbol);
                            }
                        });
                    }
                } catch (error) {
                    console.log('Could not fetch holdings, using default symbols only:', error);
                }
                
                // Populate selectors with all symbols
                allSymbols.forEach((symbol, index) => {
                    const isHolding = holdingsSymbols.includes(symbol);
                    const isDefaultSelected = index < 10;
                    
                    const chip1 = document.createElement('div');
                    // Auto-select holdings or first 10 default symbols
                    chip1.className = 'symbol-chip' + (isHolding || isDefaultSelected ? ' selected' : '');
                    chip1.textContent = symbol;
                    // Add badge for current holdings
                    if (isHolding) {
                        chip1.innerHTML = `${symbol} <span style="font-size: 0.7em; opacity: 0.7;">üíº</span>`;
                        chip1.title = 'Current holding';
                    }
                    chip1.onclick = () => chip1.classList.toggle('selected');
                    selector1.appendChild(chip1);
                    
                    const chip2 = document.createElement('div');
                    chip2.className = 'symbol-chip' + (isHolding || isDefaultSelected ? ' selected' : '');
                    chip2.textContent = symbol;
                    if (isHolding) {
                        chip2.innerHTML = `${symbol} <span style="font-size: 0.7em; opacity: 0.7;">üíº</span>`;
                        chip2.title = 'Current holding';
                    }
                    chip2.onclick = () => chip2.classList.toggle('selected');
                    selector2.appendChild(chip2);
                });
            }

            // Get selected symbols
            function getSelectedSymbols(selectorId) {
                const selector = document.getElementById(selectorId);
                const selected = [];
                selector.querySelectorAll('.symbol-chip.selected').forEach(chip => {
                    selected.push(chip.textContent);
                });
                return selected;
            }

            // Start Training
            async function startTraining() {
                const symbols = getSelectedSymbols('symbolSelector');
                const lookbackDays = parseInt(document.getElementById('lookbackDays').value);
                
                if (symbols.length === 0) {
                    alert('Please select at least one symbol');
                    return;
                }
                
                const btn = document.getElementById('startTrainingBtn');
                btn.disabled = true;
                btn.textContent = '‚è≥ Training...';
                
                document.getElementById('trainingProgress').style.display = 'block';
                document.getElementById('trainingStatus').className = 'status-badge badge-running';
                document.getElementById('trainingStatus').textContent = 'Training';
                
                try {
                    const response = await fetch('/api/ai-training/start', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ symbols, lookback_days: lookbackDays })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        pollTrainingStatus();
                    } else {
                        alert('Failed to start training: ' + data.message);
                        resetTrainingUI();
                    }
                } catch (error) {
                    alert('Error: ' + error.message);
                    resetTrainingUI();
                }
            }

            // Poll training status
            let trainingPollInterval;
            function pollTrainingStatus() {
                trainingPollInterval = setInterval(async () => {
                    try {
                        const response = await fetch('/api/ai-training/status');
                        const data = await response.json();
                        
                        if (data.success) {
                            const status = data.status;
                            const progress = status.progress || 0;
                            
                            document.getElementById('trainingProgressFill').style.width = progress + '%';
                            document.getElementById('trainingProgressText').textContent = 
                                status.current_step || 'Processing...';
                            
                            if (status.state === 'completed') {
                                clearInterval(trainingPollInterval);
                                document.getElementById('trainingStatus').className = 'status-badge badge-success';
                                document.getElementById('trainingStatus').textContent = 'Completed';
                                resetTrainingUI();
                                refreshOverview();
                            } else if (status.state === 'error') {
                                clearInterval(trainingPollInterval);
                                document.getElementById('trainingStatus').className = 'status-badge badge-error';
                                document.getElementById('trainingStatus').textContent = 'Error';
                                alert('Training error: ' + status.error);
                                resetTrainingUI();
                            }
                        }
                    } catch (error) {
                        console.error('Error polling training status:', error);
                    }
                }, 2000);
            }

            function resetTrainingUI() {
                const btn = document.getElementById('startTrainingBtn');
                btn.disabled = false;
                btn.textContent = 'üöÄ Start Training';
            }

            // Start Paper Trading
            async function startPaperTrading() {
                const symbols = getSelectedSymbols('ptSymbolSelector');
                const initialCapital = parseFloat(document.getElementById('initialCapital').value);
                
                if (symbols.length === 0) {
                    alert('Please select at least one symbol');
                    return;
                }
                
                try {
                    const response = await fetch('/api/paper-trading/start', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ symbols, initial_capital: initialCapital })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        document.getElementById('startPTBtn').style.display = 'none';
                        document.getElementById('stopPTBtn').style.display = 'inline-flex';
                        document.getElementById('ptStatus').className = 'status-badge badge-running';
                        document.getElementById('ptStatus').textContent = 'Running';
                        startPaperTradingPolling();
                    } else {
                        alert('Failed to start paper trading: ' + data.message);
                    }
                } catch (error) {
                    alert('Error: ' + error.message);
                }
            }

            // Stop Paper Trading
            async function stopPaperTrading() {
                try {
                    const response = await fetch('/api/paper-trading/stop', { method: 'POST' });
                    const data = await response.json();
                    
                    if (data.success) {
                        document.getElementById('startPTBtn').style.display = 'inline-flex';
                        document.getElementById('stopPTBtn').style.display = 'none';
                        document.getElementById('ptStatus').className = 'status-badge badge-stopped';
                        document.getElementById('ptStatus').textContent = 'Stopped';
                        stopPaperTradingPolling();
                    }
                } catch (error) {
                    alert('Error: ' + error.message);
                }
            }

            // Polling for paper trading
            let ptPollInterval;
            function startPaperTradingPolling() {
                refreshPaperTradingStatus();
                ptPollInterval = setInterval(refreshPaperTradingStatus, 5000);
            }

            function stopPaperTradingPolling() {
                if (ptPollInterval) {
                    clearInterval(ptPollInterval);
                }
            }

            async function refreshPaperTradingStatus() {
                try {
                    const response = await fetch('/api/paper-trading/status');
                    const result = await response.json();
                    
                    if (result.success && result.data) {
                        const data = result.data;
                        
                        // Update metrics
                        document.getElementById('ptIterations').textContent = 
                            result.status.iterations || 0;
                        
                        if (result.status.last_update) {
                            const date = new Date(result.status.last_update);
                            document.getElementById('ptLastUpdate').textContent = 
                                date.toLocaleTimeString();
                        }
                        
                        // Update recent trades table
                        updateRecentTradesTable(data.trade_history || []);
                        
                        // Update overview if on that tab
                        refreshOverview();
                    }
                } catch (error) {
                    console.error('Error refreshing paper trading status:', error);
                }
            }

            function updateRecentTradesTable(trades) {
                const tbody = document.querySelector('#recentTradesTable tbody');
                
                if (!trades || trades.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--text-secondary);">No trades yet</td></tr>';
                    return;
                }
                
                tbody.innerHTML = trades.reverse().map(trade => `
                    <tr>
                        <td>${new Date(trade.timestamp).toLocaleTimeString()}</td>
                        <td>${trade.symbol}</td>
                        <td>${trade.type}</td>
                        <td>${trade.quantity}</td>
                        <td>‚Çπ${trade.price.toFixed(2)}</td>
                        <td class="${trade.pnl > 0 ? 'pnl-positive' : trade.pnl < 0 ? 'pnl-negative' : ''}">
                            ${trade.pnl ? '‚Çπ' + trade.pnl.toFixed(2) : '-'}
                        </td>
                    </tr>
                `).join('');
            }

            // Refresh overview
            async function refreshOverview() {
                try {
                    const response = await fetch('/api/paper-trading/status');
                    const result = await response.json();
                    
                    if (result.success && result.data) {
                        const data = result.data;
                        
                        // Update paper trading metrics
                        document.getElementById('paperTradingState').textContent = 
                            result.status.state.toUpperCase();
                        
                        const totalTrades = data.total_trades || 0;
                        document.getElementById('totalTrades').textContent = totalTrades;
                        
                        const current = data.current_capital || 0;
                        const initial = data.initial_capital || 100000;
                        const change = ((current - initial) / initial * 100);
                        
                        document.getElementById('virtualCapital').textContent = 
                            '‚Çπ' + current.toLocaleString();
                        document.getElementById('capitalChange').textContent = 
                            (change >= 0 ? '+' : '') + change.toFixed(2) + '%';
                        document.getElementById('capitalChange').className = 
                            'metric-label ' + (change >= 0 ? 'pnl-positive' : 'pnl-negative');
                        
                        const winRate = totalTrades > 0 ? 
                            ((data.winning_trades || 0) / totalTrades * 100) : 0;
                        document.getElementById('winRate').textContent = winRate.toFixed(1) + '%';
                        
                        // Update badge
                        const badge = document.getElementById('paperTradingBadge');
                        badge.textContent = result.status.state;
                        badge.className = 'status-badge badge-' + result.status.state;
                        
                        // Update active positions
                        updateActivePositionsTable(data.positions || {});
                    }
                } catch (error) {
                    console.error('Error refreshing overview:', error);
                }
            }

            function updateActivePositionsTable(positions) {
                const tbody = document.querySelector('#activePositionsTable tbody');
                
                if (!positions || Object.keys(positions).length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: var(--text-secondary);">No active positions</td></tr>';
                    return;
                }
                
                tbody.innerHTML = Object.entries(positions).map(([symbol, pos]) => {
                    const investment = pos.quantity * pos.avg_price;
                    return `
                        <tr>
                            <td>${symbol}</td>
                            <td>${pos.quantity}</td>
                            <td>‚Çπ${pos.avg_price.toFixed(2)}</td>
                            <td>‚Çπ${investment.toFixed(2)}</td>
                            <td>-</td>
                        </tr>
                    `;
                }).join('');
            }

            // Refresh logs
            async function refreshLogs() {
                try {
                    const response = await fetch('/api/paper-trading/logs');
                    const result = await response.json();
                    
                    if (result.success && result.logs) {
                        const logViewer = document.getElementById('logViewer');
                        
                        if (result.logs.length === 0) {
                            logViewer.innerHTML = '<div class="log-entry log-info"><span class="log-timestamp">--:--:--</span><span>No logs available</span></div>';
                            return;
                        }
                        
                        logViewer.innerHTML = result.logs.map(log => {
                            const time = new Date(log.timestamp).toLocaleTimeString();
                            const levelClass = 'log-' + log.level.toLowerCase();
                            return `
                                <div class="log-entry ${levelClass}">
                                    <span class="log-timestamp">${time}</span>
                                    <span>${log.message}</span>
                                </div>
                            `;
                        }).join('');
                        
                        // Scroll to bottom
                        logViewer.scrollTop = logViewer.scrollHeight;
                    }
                } catch (error) {
                    console.error('Error refreshing logs:', error);
                }
            }

            // Refresh all
            function refreshAll() {
                refreshOverview();
                refreshPaperTradingStatus();
                refreshLogs();
            }

            // Initialize on load
            document.addEventListener('DOMContentLoaded', () => {
                populateSymbolSelectors();
                refreshAll();
                
                // Auto-refresh every 10 seconds
                setInterval(() => {
                    const activeTab = document.querySelector('.tab-content.active').id;
                    if (activeTab === 'overview-tab') refreshOverview();
                    if (activeTab === 'logs-tab') refreshLogs();
                }, 10000);
            });
        </script>
    </body>
</html>
